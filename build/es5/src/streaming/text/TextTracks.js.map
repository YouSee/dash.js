<<<<<<< HEAD
{"version":3,"sources":["../../../../../src/streaming/text/TextTracks.js"],"names":["Constants","EventBus","Events","FactoryMaker","Debug","renderHTML","TextTracks","context","eventBus","getInstance","instance","logger","Cue","videoModel","textTrackQueue","trackElementArr","currentTrackIdx","actualVideoLeft","actualVideoTop","actualVideoWidth","actualVideoHeight","captionContainer","videoSizeCheckInterval","fullscreenAttribute","displayCCOnTop","previousISDState","topZIndex","setup","getLogger","initialize","window","navigator","VTTCue","TextTrackCue","document","fullscreenElement","undefined","webkitIsFullScreen","msFullscreenElement","mozFullScreen","createTrackForUserAgent","i","kind","label","lang","isTTML","isEmbedded","track","addTextTrack","displayCConTop","value","style","zIndex","textTrackInfoVO","totalTextTracks","length","error","push","sort","a","b","index","getTTMLRenderingDiv","defaultIndex","call","defaultTrack","default","textTrack","getTrackByIdx","mode","TEXT_SHOWING","renderingType","addCaptions","captionData","trigger","TEXT_TRACK_ADDED","setCurrentTrackIdx","idx","videoTextTrack","TEXT_HIDDEN","TEXT_TRACKS_QUEUE_INITIALIZED","tracks","getVideoVisibleVideoSize","viewWidth","viewHeight","videoWidth","videoHeight","aspectRatio","use80Percent","viewAspectRatio","videoAspectRatio","videoPictureWidth","videoPictureHeight","videoPictureXAspect","videoPictureYAspect","videoPictureWidthAspect","videoPictureHeightAspect","videoPictureAspect","x","y","w","h","checkVideoSize","forceDrawing","clientWidth","getClientWidth","clientHeight","getClientHeight","getVideoWidth","getVideoHeight","videoOffsetTop","getVideoRelativeOffsetTop","videoOffsetLeft","getVideoRelativeOffsetLeft","isFromCEA608","realVideoSize","newVideoWidth","newVideoHeight","newVideoLeft","newVideoTop","containerStyle","left","top","width","height","CAPTION_CONTAINER_RESIZE","activeCues","len","cue","scaleCue","activeCue","key","replaceValue","valueFontSize","valueLineHeight","elements","cellResolution","cellUnit","linePadding","hasOwnProperty","valueLinePadding","toString","elementsSpan","getElementsByClassName","cssText","replace","fontSize","j","lineHeight","k","isd","htmlCaptionDiv","getElementById","cueID","removeChild","renderCaption","finalCue","createElement","appendChild","uri","imsc1ImgUrnTester","smpteImgUrnTester","test","match","exec","imageId","parseInt","imageData","btoa","images","dataUrl","embeddedImages","err","info","id","CAPTION_RENDERED","captionDiv","trackIdx","timeOffset","self","item","currentItem","type","start","end","cueHTMLElement","bind","onenter","debug","onexit","divs","childNodes","data","styles","align","line","position","size","addCue","e","deleteTrackCues","getTextTrack","getCurrentTrackIdx","getTrackIdxForId","trackId","setCueStyleOnTrack","clearInterval","setInterval","clearCaptionContainer","setNativeCueStyle","removeNativeCueStyle","cues","lastIdx","r","removeCue","deleteCuesFromTrackIdx","deleteAllTextTracks","ln","deleteTextTrack","splice","styleElement","head","stylesheet","sheet","video","getElement","insertRule","classList","className","message","firstChild","setConfig","config","setModeForTrackIdx","getCurrentTrackInfo","__dashjs_factory_name","getSingletonFactory"],"mappings":"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","file":"TextTracks.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport Constants from '../constants/Constants';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport { renderHTML } from 'imsc';\n\nfunction TextTracks() {\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n\n    let instance,\n        logger,\n        Cue,\n        videoModel,\n        textTrackQueue,\n        trackElementArr,\n        currentTrackIdx,\n        actualVideoLeft,\n        actualVideoTop,\n        actualVideoWidth,\n        actualVideoHeight,\n        captionContainer,\n        videoSizeCheckInterval,\n        fullscreenAttribute,\n        displayCCOnTop,\n        previousISDState,\n        topZIndex;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function initialize() {\n        if (typeof window === 'undefined' || typeof navigator === 'undefined') {\n            return;\n        }\n\n        Cue = window.VTTCue || window.TextTrackCue;\n        textTrackQueue = [];\n        trackElementArr = [];\n        currentTrackIdx = -1;\n        actualVideoLeft = 0;\n        actualVideoTop = 0;\n        actualVideoWidth = 0;\n        actualVideoHeight = 0;\n        captionContainer = null;\n        videoSizeCheckInterval = null;\n        displayCCOnTop = false;\n        topZIndex = 2147483647;\n        previousISDState = null;\n\n        if (document.fullscreenElement !== undefined) {\n            fullscreenAttribute = 'fullscreenElement'; // Standard and Edge\n        } else if (document.webkitIsFullScreen !== undefined) {\n            fullscreenAttribute = 'webkitIsFullScreen'; // Chrome and Safari (and Edge)\n        } else if (document.msFullscreenElement) { // IE11\n            fullscreenAttribute = 'msFullscreenElement';\n        } else if (document.mozFullScreen) { // Firefox\n            fullscreenAttribute = 'mozFullScreen';\n        }\n\n    }\n\n    function createTrackForUserAgent (i) {\n        const kind = textTrackQueue[i].kind;\n        const label = textTrackQueue[i].label !== undefined ? textTrackQueue[i].label : textTrackQueue[i].lang;\n        const lang = textTrackQueue[i].lang;\n        const isTTML = textTrackQueue[i].isTTML;\n        const isEmbedded = textTrackQueue[i].isEmbedded;\n        const track = videoModel.addTextTrack(kind, label, lang);\n\n        track.isEmbedded = isEmbedded;\n        track.isTTML = isTTML;\n\n        return track;\n    }\n\n    function displayCConTop(value) {\n        displayCCOnTop = value;\n        if (!captionContainer) {\n            return;\n        }\n        captionContainer.style.zIndex = value ? topZIndex : null;\n    }\n\n    function addTextTrack(textTrackInfoVO, totalTextTracks) {\n        if (textTrackQueue.length === totalTextTracks) {\n            logger.error('Trying to add too many tracks.');\n            return;\n        }\n\n        textTrackQueue.push(textTrackInfoVO);\n\n        if (textTrackQueue.length === totalTextTracks) {\n            textTrackQueue.sort(function (a, b) { //Sort in same order as in manifest\n                return a.index - b.index;\n            });\n            captionContainer = videoModel.getTTMLRenderingDiv();\n            let defaultIndex = -1;\n            for (let i = 0 ; i < textTrackQueue.length; i++) {\n                const track = createTrackForUserAgent.call(this, i);\n                trackElementArr.push(track); //used to remove tracks from video element when added manually\n\n                if (textTrackQueue[i].defaultTrack) {\n                    // track.default is an object property identifier that is a reserved word\n                    // The following jshint directive is used to suppressed the warning \"Expected an identifier and instead saw 'default' (a reserved word)\"\n                    /*jshint -W024 */\n                    track.default = true;\n                    defaultIndex = i;\n                }\n\n                const textTrack = getTrackByIdx(i);\n                if (textTrack) {\n                    //each time a track is created, its mode should be showing by default\n                    //sometime, it's not on Chrome\n                    textTrack.mode = Constants.TEXT_SHOWING;\n                    if (captionContainer && (textTrackQueue[i].isTTML || textTrackQueue[i].isEmbedded)) {\n                        textTrack.renderingType = 'html';\n                    } else {\n                        textTrack.renderingType = 'default';\n                    }\n                }\n                this.addCaptions(i, 0, textTrackQueue[i].captionData);\n                eventBus.trigger(Events.TEXT_TRACK_ADDED);\n            }\n\n            //set current track index in textTrackQueue array\n            setCurrentTrackIdx.call(this, defaultIndex);\n\n            if (defaultIndex >= 0) {\n                for (let idx = 0; idx < textTrackQueue.length; idx++) {\n                    const videoTextTrack = getTrackByIdx(idx);\n                    if (videoTextTrack) {\n                        videoTextTrack.mode = (idx === defaultIndex) ? Constants.TEXT_SHOWING : Constants.TEXT_HIDDEN;\n                    }\n                }\n            }\n\n            eventBus.trigger(Events.TEXT_TRACKS_QUEUE_INITIALIZED, {\n                index: currentTrackIdx,\n                tracks: textTrackQueue\n            }); //send default idx.\n        }\n    }\n\n    function getVideoVisibleVideoSize(viewWidth, viewHeight, videoWidth, videoHeight, aspectRatio, use80Percent) {\n        const viewAspectRatio = viewWidth / viewHeight;\n        const videoAspectRatio = videoWidth / videoHeight;\n\n        let videoPictureWidth = 0;\n        let videoPictureHeight = 0;\n\n        if (viewAspectRatio > videoAspectRatio) {\n            videoPictureHeight = viewHeight;\n            videoPictureWidth = (videoPictureHeight / videoHeight) * videoWidth;\n        } else {\n            videoPictureWidth = viewWidth;\n            videoPictureHeight = (videoPictureWidth / videoWidth) * videoHeight;\n        }\n\n        let videoPictureXAspect = 0;\n        let videoPictureYAspect = 0;\n        let videoPictureWidthAspect = 0;\n        let videoPictureHeightAspect = 0;\n        const videoPictureAspect = videoPictureWidth / videoPictureHeight;\n\n        if (videoPictureAspect > aspectRatio) {\n            videoPictureHeightAspect = videoPictureHeight;\n            videoPictureWidthAspect = videoPictureHeight * aspectRatio;\n        } else {\n            videoPictureWidthAspect = videoPictureWidth;\n            videoPictureHeightAspect = videoPictureWidth / aspectRatio;\n        }\n        videoPictureXAspect = (viewWidth - videoPictureWidthAspect) / 2;\n        videoPictureYAspect = (viewHeight - videoPictureHeightAspect) / 2;\n\n        if (use80Percent) {\n            return {\n                x: videoPictureXAspect + (videoPictureWidthAspect * 0.1),\n                y: videoPictureYAspect + (videoPictureHeightAspect * 0.1),\n                w: videoPictureWidthAspect * 0.8,\n                h: videoPictureHeightAspect * 0.8\n            }; /* Maximal picture size in videos aspect ratio */\n        } else {\n            return {\n                x: videoPictureXAspect,\n                y: videoPictureYAspect,\n                w: videoPictureWidthAspect,\n                h: videoPictureHeightAspect\n            }; /* Maximal picture size in videos aspect ratio */\n        }\n    }\n\n    function checkVideoSize(track, forceDrawing) {\n        const clientWidth = videoModel.getClientWidth();\n        const clientHeight = videoModel.getClientHeight();\n        const videoWidth = videoModel.getVideoWidth();\n        const videoHeight = videoModel.getVideoHeight();\n        const videoOffsetTop = videoModel.getVideoRelativeOffsetTop();\n        const videoOffsetLeft = videoModel.getVideoRelativeOffsetLeft();\n        let aspectRatio =  videoWidth / videoHeight;\n        let use80Percent = false;\n        if (track.isFromCEA608) {\n            // If this is CEA608 then use predefined aspect ratio\n            aspectRatio = 3.5 / 3.0;\n            use80Percent = true;\n        }\n\n        const realVideoSize = getVideoVisibleVideoSize.call(this, clientWidth, clientHeight, videoWidth, videoHeight, aspectRatio, use80Percent);\n\n        const newVideoWidth = realVideoSize.w;\n        const newVideoHeight = realVideoSize.h;\n        const newVideoLeft = realVideoSize.x;\n        const newVideoTop = realVideoSize.y;\n\n        if (newVideoWidth != actualVideoWidth || newVideoHeight != actualVideoHeight || newVideoLeft != actualVideoLeft || newVideoTop != actualVideoTop || forceDrawing) {\n            actualVideoLeft = newVideoLeft + videoOffsetLeft;\n            actualVideoTop = newVideoTop + videoOffsetTop;\n            actualVideoWidth = newVideoWidth;\n            actualVideoHeight = newVideoHeight;\n\n            if (captionContainer) {\n                const containerStyle = captionContainer.style;\n                containerStyle.left = actualVideoLeft + 'px';\n                containerStyle.top = actualVideoTop + 'px';\n                containerStyle.width = actualVideoWidth + 'px';\n                containerStyle.height = actualVideoHeight + 'px';\n                containerStyle.zIndex = displayCCOnTop ? topZIndex : null;\n                eventBus.trigger(Events.CAPTION_CONTAINER_RESIZE, {});\n            }\n\n            // Video view has changed size, so resize any active cues\n            const activeCues = track.activeCues;\n            if (activeCues) {\n                const len = activeCues.length;\n                for (let i = 0; i < len; ++i) {\n                    const cue = activeCues[i];\n                    cue.scaleCue(cue);\n                }\n            }\n        }\n    }\n\n    function scaleCue(activeCue) {\n        const videoWidth = actualVideoWidth;\n        const videoHeight = actualVideoHeight;\n        let key,\n            replaceValue,\n            valueFontSize,\n            valueLineHeight,\n            elements;\n\n        if (activeCue.cellResolution) {\n            const cellUnit = [videoWidth / activeCue.cellResolution[0], videoHeight / activeCue.cellResolution[1]];\n            if (activeCue.linePadding) {\n                for (key in activeCue.linePadding) {\n                    if (activeCue.linePadding.hasOwnProperty(key)) {\n                        const valueLinePadding = activeCue.linePadding[key];\n                        replaceValue = (valueLinePadding * cellUnit[0]).toString();\n                        // Compute the CellResolution unit in order to process properties using sizing (fontSize, linePadding, etc).\n                        const elementsSpan = document.getElementsByClassName('spanPadding');\n                        for (let i = 0; i < elementsSpan.length; i++) {\n                            elementsSpan[i].style.cssText = elementsSpan[i].style.cssText.replace(/(padding-left\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                            elementsSpan[i].style.cssText = elementsSpan[i].style.cssText.replace(/(padding-right\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                        }\n                    }\n                }\n            }\n\n            if (activeCue.fontSize) {\n                for (key in activeCue.fontSize) {\n                    if (activeCue.fontSize.hasOwnProperty(key)) {\n                        if (activeCue.fontSize[key][0] === '%') {\n                            valueFontSize = activeCue.fontSize[key][1] / 100;\n                        } else if (activeCue.fontSize[key][0] === 'c') {\n                            valueFontSize = activeCue.fontSize[key][1];\n                        }\n\n                        replaceValue = (valueFontSize * cellUnit[1]).toString();\n\n                        if (key !== 'defaultFontSize') {\n                            elements = document.getElementsByClassName(key);\n                        } else {\n                            elements = document.getElementsByClassName('paragraph');\n                        }\n\n                        for (let j = 0; j < elements.length; j++) {\n                            elements[j].style.cssText = elements[j].style.cssText.replace(/(font-size\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                        }\n                    }\n                }\n\n                if (activeCue.lineHeight) {\n                    for (key in activeCue.lineHeight) {\n                        if (activeCue.lineHeight.hasOwnProperty(key)) {\n                            if (activeCue.lineHeight[key][0] === '%') {\n                                valueLineHeight = activeCue.lineHeight[key][1] / 100;\n                            } else if (activeCue.fontSize[key][0] === 'c') {\n                                valueLineHeight = activeCue.lineHeight[key][1];\n                            }\n\n                            replaceValue = (valueLineHeight * cellUnit[1]).toString();\n                            elements = document.getElementsByClassName(key);\n                            for (let k = 0; k < elements.length; k++) {\n                                elements[k].style.cssText = elements[k].style.cssText.replace(/(line-height\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        if (activeCue.isd) {\n            let htmlCaptionDiv = document.getElementById(activeCue.cueID);\n            if (htmlCaptionDiv) {\n                captionContainer.removeChild(htmlCaptionDiv);\n            }\n            renderCaption(activeCue);\n        }\n    }\n\n    function renderCaption(cue) {\n        if (captionContainer) {\n            const finalCue = document.createElement('div');\n            captionContainer.appendChild(finalCue);\n            previousISDState = renderHTML(cue.isd, finalCue, function (uri) {\n                const imsc1ImgUrnTester = /^(urn:)(mpeg:[a-z0-9][a-z0-9-]{0,31}:)(subs:)([0-9]+)$/;\n                const smpteImgUrnTester = /^#(.*)$/;\n                if (imsc1ImgUrnTester.test(uri)) {\n                    const match = imsc1ImgUrnTester.exec(uri);\n                    const imageId = parseInt(match[4], 10) - 1;\n                    const imageData = btoa(cue.images[imageId]);\n                    const dataUrl = 'data:image/png;base64,' + imageData;\n                    return dataUrl;\n                } else if (smpteImgUrnTester.test(uri)) {\n                    const match = smpteImgUrnTester.exec(uri);\n                    const imageId = match[1];\n                    const dataUrl = 'data:image/png;base64,' + cue.embeddedImages[imageId];\n                    return dataUrl;\n                } else {\n                    return null;\n                }\n            }, captionContainer.clientHeight, captionContainer.clientWidth, false/*displayForcedOnlyMode*/, function (err) {\n                logger.info('renderCaption :', err);\n                //TODO add ErrorHandler management\n            }, previousISDState, true /*enableRollUp*/);\n            finalCue.id = cue.cueID;\n            eventBus.trigger(Events.CAPTION_RENDERED, {captionDiv: finalCue, currentTrackIdx});\n        }\n    }\n\n    /*\n     * Add captions to track, store for later adding, or add captions added before\n     */\n    function addCaptions(trackIdx, timeOffset, captionData) {\n        const track = getTrackByIdx(trackIdx);\n        const self = this;\n\n        if (!track) {\n            return;\n        }\n\n        if (!captionData || captionData.length === 0) {\n            return;\n        }\n\n        for (let item = 0; item < captionData.length; item++) {\n            let cue;\n            const currentItem = captionData[item];\n\n            track.cellResolution = currentItem.cellResolution;\n            track.isFromCEA608 = currentItem.isFromCEA608;\n\n            if (currentItem.type === 'html' && captionContainer) {\n                cue = new Cue(currentItem.start - timeOffset, currentItem.end - timeOffset, '');\n                cue.cueHTMLElement = currentItem.cueHTMLElement;\n                cue.isd = currentItem.isd;\n                cue.images = currentItem.images;\n                cue.embeddedImages = currentItem.embeddedImages;\n                cue.cueID = currentItem.cueID;\n                cue.scaleCue = scaleCue.bind(self);\n                //useful parameters for cea608 subtitles, not for TTML one.\n                cue.cellResolution = currentItem.cellResolution;\n                cue.lineHeight = currentItem.lineHeight;\n                cue.linePadding = currentItem.linePadding;\n                cue.fontSize = currentItem.fontSize;\n\n                captionContainer.style.left = actualVideoLeft + 'px';\n                captionContainer.style.top = actualVideoTop + 'px';\n                captionContainer.style.width = actualVideoWidth + 'px';\n                captionContainer.style.height = actualVideoHeight + 'px';\n\n                cue.onenter = function () {\n                    if (track.mode === Constants.TEXT_SHOWING) {\n                        if (this.isd) {\n                            renderCaption(this);\n                            logger.debug('Cue enter id:' + this.cueID);\n                        } else {\n                            captionContainer.appendChild(this.cueHTMLElement);\n                            scaleCue.call(self, this);\n                            eventBus.trigger(Events.CAPTION_RENDERED, {captionDiv: this.cueHTMLElement, currentTrackIdx});\n                        }\n                    }\n                };\n\n                cue.onexit = function () {\n                    if (captionContainer) {\n                        const divs = captionContainer.childNodes;\n                        for (let i = 0; i < divs.length; ++i) {\n                            if (divs[i].id === this.cueID) {\n                                logger.debug('Cue exit id:' + divs[i].id);\n                                captionContainer.removeChild(divs[i]);\n                            }\n                        }\n                    }\n                };\n            } else {\n                if (currentItem.data) {\n                    cue = new Cue(currentItem.start - timeOffset, currentItem.end - timeOffset, currentItem.data);\n                    if (currentItem.styles) {\n                        if (currentItem.styles.align !== undefined && 'align' in cue) {\n                            cue.align = currentItem.styles.align;\n                        }\n                        if (currentItem.styles.line !== undefined && 'line' in cue) {\n                            cue.line = currentItem.styles.line;\n                        }\n                        if (currentItem.styles.position !== undefined && 'position' in cue) {\n                            cue.position = currentItem.styles.position;\n                        }\n                        if (currentItem.styles.size !== undefined && 'size' in cue) {\n                            cue.size = currentItem.styles.size;\n                        }\n                    }\n                    cue.onenter = function () {\n                        if (track.mode === Constants.TEXT_SHOWING) {\n                            eventBus.trigger(Events.CAPTION_RENDERED, {currentTrackIdx});\n                        }\n                    };\n                }\n            }\n            try {\n                if (cue) {\n                    track.addCue(cue);\n                } else {\n                    logger.error('impossible to display subtitles.');\n                }\n            } catch (e) {\n                // Edge crash, delete everything and start adding again\n                // @see https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11979877/\n                deleteTrackCues(track);\n                track.addCue(cue);\n                throw e;\n            }\n        }\n    }\n\n    function getTrackByIdx(idx) {\n        return idx >= 0 && textTrackQueue[idx] ?\n            videoModel.getTextTrack(textTrackQueue[idx].kind, textTrackQueue[idx].label, textTrackQueue[idx].lang, textTrackQueue[idx].isTTML, textTrackQueue[idx].isEmbedded) : null;\n    }\n\n    function getCurrentTrackIdx() {\n        return currentTrackIdx;\n    }\n\n    function getTrackIdxForId(trackId) {\n        let idx = -1;\n        for (let i = 0; i < textTrackQueue.length; i++) {\n            if (textTrackQueue[i].label === trackId) {\n                idx = i;\n                break;\n            }\n        }\n\n        return idx;\n    }\n\n    function setCurrentTrackIdx(idx) {\n        if (idx === currentTrackIdx) {\n            return;\n        }\n        currentTrackIdx = idx;\n        const track = getTrackByIdx(currentTrackIdx);\n        setCueStyleOnTrack.call(this, track);\n\n        if (videoSizeCheckInterval) {\n            clearInterval(videoSizeCheckInterval);\n            videoSizeCheckInterval = null;\n        }\n\n        if (track && track.renderingType === 'html') {\n            checkVideoSize.call(this, track, true);\n            videoSizeCheckInterval = setInterval(checkVideoSize.bind(this, track), 500);\n        }\n    }\n\n    function setCueStyleOnTrack(track) {\n        clearCaptionContainer.call(this);\n        if (track) {\n            if (track.renderingType === 'html') {\n                setNativeCueStyle.call(this);\n            } else {\n                removeNativeCueStyle.call(this);\n            }\n        } else {\n            removeNativeCueStyle.call(this);\n        }\n    }\n\n    function deleteTrackCues(track) {\n        if (track.cues) {\n            const cues = track.cues;\n            const lastIdx = cues.length - 1;\n\n            for (let r = lastIdx; r >= 0 ; r--) {\n                track.removeCue(cues[r]);\n            }\n        }\n    }\n\n    function deleteCuesFromTrackIdx(trackIdx) {\n        const track = getTrackByIdx(trackIdx);\n        if (track) {\n            deleteTrackCues(track);\n        }\n    }\n\n    function deleteAllTextTracks() {\n        const ln = trackElementArr ? trackElementArr.length : 0;\n        for (let i = 0; i < ln; i++) {\n            const track = getTrackByIdx(i);\n            if (track) {\n                deleteTrackCues.call(this, track);\n                track.mode = 'disabled';\n            }\n        }\n        trackElementArr = [];\n        textTrackQueue = [];\n        if (videoSizeCheckInterval) {\n            clearInterval(videoSizeCheckInterval);\n            videoSizeCheckInterval = null;\n        }\n        currentTrackIdx = -1;\n        clearCaptionContainer.call(this);\n    }\n\n    function deleteTextTrack(idx) {\n        videoModel.removeChild(trackElementArr[idx]);\n        trackElementArr.splice(idx, 1);\n    }\n\n    /* Set native cue style to transparent background to avoid it being displayed. */\n    function setNativeCueStyle() {\n        let styleElement = document.getElementById('native-cue-style');\n        if (styleElement) {\n            return; //Already set\n        }\n\n        styleElement = document.createElement('style');\n        styleElement.id = 'native-cue-style';\n        document.head.appendChild(styleElement);\n        const stylesheet = styleElement.sheet;\n        const video = videoModel.getElement();\n        try {\n            if (video) {\n                if (video.id) {\n                    stylesheet.insertRule('#' + video.id + '::cue {background: transparent}', 0);\n                } else if (video.classList.length !== 0) {\n                    stylesheet.insertRule('.' + video.className + '::cue {background: transparent}', 0);\n                } else {\n                    stylesheet.insertRule('video::cue {background: transparent}', 0);\n                }\n            }\n        } catch (e) {\n            logger.info('' + e.message);\n        }\n    }\n\n    /* Remove the extra cue style with transparent background for native cues. */\n    function removeNativeCueStyle() {\n        const styleElement = document.getElementById('native-cue-style');\n        if (styleElement) {\n            document.head.removeChild(styleElement);\n        }\n    }\n\n    function clearCaptionContainer() {\n        if (captionContainer) {\n            while (captionContainer.firstChild) {\n                captionContainer.removeChild(captionContainer.firstChild);\n            }\n        }\n    }\n\n    function setConfig(config) {\n        if (!config) {\n            return;\n        }\n        if (config.videoModel) {\n            videoModel = config.videoModel;\n        }\n    }\n\n    function setModeForTrackIdx(idx, mode) {\n        const track = getTrackByIdx(idx);\n        if (track && track.mode !== mode) {\n            track.mode = mode;\n        }\n    }\n\n    function getCurrentTrackInfo() {\n        return textTrackQueue[currentTrackIdx];\n    }\n\n    instance = {\n        initialize: initialize,\n        displayCConTop: displayCConTop,\n        addTextTrack: addTextTrack,\n        addCaptions: addCaptions,\n        getCurrentTrackIdx: getCurrentTrackIdx,\n        setCurrentTrackIdx: setCurrentTrackIdx,\n        getTrackIdxForId: getTrackIdxForId,\n        getCurrentTrackInfo: getCurrentTrackInfo,\n        setModeForTrackIdx: setModeForTrackIdx,\n        deleteCuesFromTrackIdx: deleteCuesFromTrackIdx,\n        deleteAllTextTracks: deleteAllTextTracks,\n        deleteTextTrack: deleteTextTrack,\n        setConfig: setConfig\n    };\n\n    setup();\n\n    return instance;\n}\n\nTextTracks.__dashjs_factory_name = 'TextTracks';\nexport default FactoryMaker.getSingletonFactory(TextTracks);\n"]}
=======
{"version":3,"sources":["../../../../../src/streaming/text/TextTracks.js"],"names":["TextTracks","context","eventBus","getInstance","instance","logger","Cue","videoModel","textTrackQueue","trackElementArr","currentTrackIdx","actualVideoLeft","actualVideoTop","actualVideoWidth","actualVideoHeight","captionContainer","videoSizeCheckInterval","fullscreenAttribute","displayCCOnTop","previousISDState","topZIndex","setup","getLogger","initialize","window","navigator","VTTCue","TextTrackCue","document","fullscreenElement","undefined","webkitIsFullScreen","msFullscreenElement","mozFullScreen","createTrackForUserAgent","i","kind","label","lang","isTTML","isEmbedded","track","addTextTrack","displayCConTop","value","style","zIndex","textTrackInfoVO","totalTextTracks","length","error","push","sort","a","b","index","getTTMLRenderingDiv","defaultIndex","call","defaultTrack","default","textTrack","getTrackByIdx","mode","Constants","TEXT_SHOWING","renderingType","addCaptions","captionData","trigger","Events","TEXT_TRACK_ADDED","setCurrentTrackIdx","idx","videoTextTrack","TEXT_HIDDEN","TEXT_TRACKS_QUEUE_INITIALIZED","tracks","getVideoVisibleVideoSize","viewWidth","viewHeight","videoWidth","videoHeight","aspectRatio","use80Percent","viewAspectRatio","videoAspectRatio","videoPictureWidth","videoPictureHeight","videoPictureXAspect","videoPictureYAspect","videoPictureWidthAspect","videoPictureHeightAspect","videoPictureAspect","x","y","w","h","checkVideoSize","forceDrawing","clientWidth","getClientWidth","clientHeight","getClientHeight","getVideoWidth","getVideoHeight","videoOffsetTop","getVideoRelativeOffsetTop","videoOffsetLeft","getVideoRelativeOffsetLeft","isFromCEA608","realVideoSize","newVideoWidth","newVideoHeight","newVideoLeft","newVideoTop","containerStyle","left","top","width","height","CAPTION_CONTAINER_RESIZE","activeCues","len","cue","scaleCue","activeCue","key","replaceValue","valueFontSize","valueLineHeight","elements","cellResolution","cellUnit","linePadding","hasOwnProperty","valueLinePadding","toString","elementsSpan","getElementsByClassName","cssText","replace","fontSize","j","lineHeight","k","isd","htmlCaptionDiv","getElementById","cueID","removeChild","renderCaption","finalCue","createElement","appendChild","uri","imsc1ImgUrnTester","smpteImgUrnTester","test","match","exec","imageId","parseInt","imageData","btoa","images","dataUrl","embeddedImages","err","info","id","CAPTION_RENDERED","captionDiv","trackIdx","timeOffset","self","item","currentItem","type","start","end","cueHTMLElement","bind","onenter","debug","onexit","divs","childNodes","data","styles","align","line","position","size","addCue","e","deleteTrackCues","getTextTrack","getCurrentTrackIdx","getTrackIdxForId","trackId","setCueStyleOnTrack","clearInterval","setInterval","clearCaptionContainer","setNativeCueStyle","removeNativeCueStyle","cues","lastIdx","r","removeCue","deleteCuesFromTrackIdx","deleteAllTextTracks","ln","deleteTextTrack","splice","styleElement","head","stylesheet","sheet","video","getElement","insertRule","classList","className","message","firstChild","setConfig","config","setModeForTrackIdx","getCurrentTrackInfo","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"TextTracks.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport Constants from '../constants/Constants';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport { renderHTML } from 'imsc';\n\nfunction TextTracks() {\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n\n    let instance,\n        logger,\n        Cue,\n        videoModel,\n        textTrackQueue,\n        trackElementArr,\n        currentTrackIdx,\n        actualVideoLeft,\n        actualVideoTop,\n        actualVideoWidth,\n        actualVideoHeight,\n        captionContainer,\n        videoSizeCheckInterval,\n        fullscreenAttribute,\n        displayCCOnTop,\n        previousISDState,\n        topZIndex;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function initialize() {\n        if (typeof window === 'undefined' || typeof navigator === 'undefined') {\n            return;\n        }\n\n        Cue = window.VTTCue || window.TextTrackCue;\n        textTrackQueue = [];\n        trackElementArr = [];\n        currentTrackIdx = -1;\n        actualVideoLeft = 0;\n        actualVideoTop = 0;\n        actualVideoWidth = 0;\n        actualVideoHeight = 0;\n        captionContainer = null;\n        videoSizeCheckInterval = null;\n        displayCCOnTop = false;\n        topZIndex = 2147483647;\n        previousISDState = null;\n\n        if (document.fullscreenElement !== undefined) {\n            fullscreenAttribute = 'fullscreenElement'; // Standard and Edge\n        } else if (document.webkitIsFullScreen !== undefined) {\n            fullscreenAttribute = 'webkitIsFullScreen'; // Chrome and Safari (and Edge)\n        } else if (document.msFullscreenElement) { // IE11\n            fullscreenAttribute = 'msFullscreenElement';\n        } else if (document.mozFullScreen) { // Firefox\n            fullscreenAttribute = 'mozFullScreen';\n        }\n\n    }\n\n    function createTrackForUserAgent (i) {\n        const kind = textTrackQueue[i].kind;\n        const label = textTrackQueue[i].label !== undefined ? textTrackQueue[i].label : textTrackQueue[i].lang;\n        const lang = textTrackQueue[i].lang;\n        const isTTML = textTrackQueue[i].isTTML;\n        const isEmbedded = textTrackQueue[i].isEmbedded;\n        const track = videoModel.addTextTrack(kind, label, lang);\n\n        track.isEmbedded = isEmbedded;\n        track.isTTML = isTTML;\n\n        return track;\n    }\n\n    function displayCConTop(value) {\n        displayCCOnTop = value;\n        if (!captionContainer || document[fullscreenAttribute]) {\n            return;\n        }\n        captionContainer.style.zIndex = value ? topZIndex : null;\n    }\n\n    function addTextTrack(textTrackInfoVO, totalTextTracks) {\n        if (textTrackQueue.length === totalTextTracks) {\n            logger.error('Trying to add too many tracks.');\n            return;\n        }\n\n        textTrackQueue.push(textTrackInfoVO);\n\n        if (textTrackQueue.length === totalTextTracks) {\n            textTrackQueue.sort(function (a, b) { //Sort in same order as in manifest\n                return a.index - b.index;\n            });\n            captionContainer = videoModel.getTTMLRenderingDiv();\n            let defaultIndex = -1;\n            for (let i = 0 ; i < textTrackQueue.length; i++) {\n                const track = createTrackForUserAgent.call(this, i);\n                trackElementArr.push(track); //used to remove tracks from video element when added manually\n\n                if (textTrackQueue[i].defaultTrack) {\n                    // track.default is an object property identifier that is a reserved word\n                    // The following jshint directive is used to suppressed the warning \"Expected an identifier and instead saw 'default' (a reserved word)\"\n                    /*jshint -W024 */\n                    track.default = true;\n                    defaultIndex = i;\n                }\n\n                const textTrack = getTrackByIdx(i);\n                if (textTrack) {\n                    //each time a track is created, its mode should be showing by default\n                    //sometime, it's not on Chrome\n                    textTrack.mode = Constants.TEXT_SHOWING;\n                    if (captionContainer && (textTrackQueue[i].isTTML || textTrackQueue[i].isEmbedded)) {\n                        textTrack.renderingType = 'html';\n                    } else {\n                        textTrack.renderingType = 'default';\n                    }\n                }\n                this.addCaptions(i, 0, textTrackQueue[i].captionData);\n                eventBus.trigger(Events.TEXT_TRACK_ADDED);\n            }\n\n            //set current track index in textTrackQueue array\n            setCurrentTrackIdx.call(this, defaultIndex);\n\n            if (defaultIndex >= 0) {\n                for (let idx = 0; idx < textTrackQueue.length; idx++) {\n                    const videoTextTrack = getTrackByIdx(idx);\n                    if (videoTextTrack) {\n                        videoTextTrack.mode = (idx === defaultIndex) ? Constants.TEXT_SHOWING : Constants.TEXT_HIDDEN;\n                    }\n                }\n            }\n\n            eventBus.trigger(Events.TEXT_TRACKS_QUEUE_INITIALIZED, {\n                index: currentTrackIdx,\n                tracks: textTrackQueue\n            }); //send default idx.\n        }\n    }\n\n    function getVideoVisibleVideoSize(viewWidth, viewHeight, videoWidth, videoHeight, aspectRatio, use80Percent) {\n        const viewAspectRatio = viewWidth / viewHeight;\n        const videoAspectRatio = videoWidth / videoHeight;\n\n        let videoPictureWidth = 0;\n        let videoPictureHeight = 0;\n\n        if (viewAspectRatio > videoAspectRatio) {\n            videoPictureHeight = viewHeight;\n            videoPictureWidth = (videoPictureHeight / videoHeight) * videoWidth;\n        } else {\n            videoPictureWidth = viewWidth;\n            videoPictureHeight = (videoPictureWidth / videoWidth) * videoHeight;\n        }\n\n        let videoPictureXAspect = 0;\n        let videoPictureYAspect = 0;\n        let videoPictureWidthAspect = 0;\n        let videoPictureHeightAspect = 0;\n        const videoPictureAspect = videoPictureWidth / videoPictureHeight;\n\n        if (videoPictureAspect > aspectRatio) {\n            videoPictureHeightAspect = videoPictureHeight;\n            videoPictureWidthAspect = videoPictureHeight * aspectRatio;\n        } else {\n            videoPictureWidthAspect = videoPictureWidth;\n            videoPictureHeightAspect = videoPictureWidth / aspectRatio;\n        }\n        videoPictureXAspect = (viewWidth - videoPictureWidthAspect) / 2;\n        videoPictureYAspect = (viewHeight - videoPictureHeightAspect) / 2;\n\n        if (use80Percent) {\n            return {\n                x: videoPictureXAspect + (videoPictureWidthAspect * 0.1),\n                y: videoPictureYAspect + (videoPictureHeightAspect * 0.1),\n                w: videoPictureWidthAspect * 0.8,\n                h: videoPictureHeightAspect * 0.8\n            }; /* Maximal picture size in videos aspect ratio */\n        } else {\n            return {\n                x: videoPictureXAspect,\n                y: videoPictureYAspect,\n                w: videoPictureWidthAspect,\n                h: videoPictureHeightAspect\n            }; /* Maximal picture size in videos aspect ratio */\n        }\n    }\n\n    function checkVideoSize(track, forceDrawing) {\n        const clientWidth = videoModel.getClientWidth();\n        const clientHeight = videoModel.getClientHeight();\n        const videoWidth = videoModel.getVideoWidth();\n        const videoHeight = videoModel.getVideoHeight();\n        const videoOffsetTop = videoModel.getVideoRelativeOffsetTop();\n        const videoOffsetLeft = videoModel.getVideoRelativeOffsetLeft();\n        let aspectRatio =  videoWidth / videoHeight;\n        let use80Percent = false;\n        if (track.isFromCEA608) {\n            // If this is CEA608 then use predefined aspect ratio\n            aspectRatio = 3.5 / 3.0;\n            use80Percent = true;\n        }\n\n        const realVideoSize = getVideoVisibleVideoSize.call(this, clientWidth, clientHeight, videoWidth, videoHeight, aspectRatio, use80Percent);\n\n        const newVideoWidth = realVideoSize.w;\n        const newVideoHeight = realVideoSize.h;\n        const newVideoLeft = realVideoSize.x;\n        const newVideoTop = realVideoSize.y;\n\n        if (newVideoWidth != actualVideoWidth || newVideoHeight != actualVideoHeight || newVideoLeft != actualVideoLeft || newVideoTop != actualVideoTop || forceDrawing) {\n            actualVideoLeft = newVideoLeft + videoOffsetLeft;\n            actualVideoTop = newVideoTop + videoOffsetTop;\n            actualVideoWidth = newVideoWidth;\n            actualVideoHeight = newVideoHeight;\n\n            if (captionContainer) {\n                const containerStyle = captionContainer.style;\n                containerStyle.left = actualVideoLeft + 'px';\n                containerStyle.top = actualVideoTop + 'px';\n                containerStyle.width = actualVideoWidth + 'px';\n                containerStyle.height = actualVideoHeight + 'px';\n                containerStyle.zIndex = (fullscreenAttribute && document[fullscreenAttribute]) || displayCCOnTop ? topZIndex : null;\n                eventBus.trigger(Events.CAPTION_CONTAINER_RESIZE, {});\n            }\n\n            // Video view has changed size, so resize any active cues\n            const activeCues = track.activeCues;\n            if (activeCues) {\n                const len = activeCues.length;\n                for (let i = 0; i < len; ++i) {\n                    const cue = activeCues[i];\n                    cue.scaleCue(cue);\n                }\n            }\n        }\n    }\n\n    function scaleCue(activeCue) {\n        const videoWidth = actualVideoWidth;\n        const videoHeight = actualVideoHeight;\n        let key,\n            replaceValue,\n            valueFontSize,\n            valueLineHeight,\n            elements;\n\n        if (activeCue.cellResolution) {\n            const cellUnit = [videoWidth / activeCue.cellResolution[0], videoHeight / activeCue.cellResolution[1]];\n            if (activeCue.linePadding) {\n                for (key in activeCue.linePadding) {\n                    if (activeCue.linePadding.hasOwnProperty(key)) {\n                        const valueLinePadding = activeCue.linePadding[key];\n                        replaceValue = (valueLinePadding * cellUnit[0]).toString();\n                        // Compute the CellResolution unit in order to process properties using sizing (fontSize, linePadding, etc).\n                        const elementsSpan = document.getElementsByClassName('spanPadding');\n                        for (let i = 0; i < elementsSpan.length; i++) {\n                            elementsSpan[i].style.cssText = elementsSpan[i].style.cssText.replace(/(padding-left\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                            elementsSpan[i].style.cssText = elementsSpan[i].style.cssText.replace(/(padding-right\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                        }\n                    }\n                }\n            }\n\n            if (activeCue.fontSize) {\n                for (key in activeCue.fontSize) {\n                    if (activeCue.fontSize.hasOwnProperty(key)) {\n                        if (activeCue.fontSize[key][0] === '%') {\n                            valueFontSize = activeCue.fontSize[key][1] / 100;\n                        } else if (activeCue.fontSize[key][0] === 'c') {\n                            valueFontSize = activeCue.fontSize[key][1];\n                        }\n\n                        replaceValue = (valueFontSize * cellUnit[1]).toString();\n\n                        if (key !== 'defaultFontSize') {\n                            elements = document.getElementsByClassName(key);\n                        } else {\n                            elements = document.getElementsByClassName('paragraph');\n                        }\n\n                        for (let j = 0; j < elements.length; j++) {\n                            elements[j].style.cssText = elements[j].style.cssText.replace(/(font-size\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                        }\n                    }\n                }\n\n                if (activeCue.lineHeight) {\n                    for (key in activeCue.lineHeight) {\n                        if (activeCue.lineHeight.hasOwnProperty(key)) {\n                            if (activeCue.lineHeight[key][0] === '%') {\n                                valueLineHeight = activeCue.lineHeight[key][1] / 100;\n                            } else if (activeCue.fontSize[key][0] === 'c') {\n                                valueLineHeight = activeCue.lineHeight[key][1];\n                            }\n\n                            replaceValue = (valueLineHeight * cellUnit[1]).toString();\n                            elements = document.getElementsByClassName(key);\n                            for (let k = 0; k < elements.length; k++) {\n                                elements[k].style.cssText = elements[k].style.cssText.replace(/(line-height\\s*:\\s*)[\\d.,]+(?=\\s*px)/gi, '$1' + replaceValue);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        if (activeCue.isd) {\n            let htmlCaptionDiv = document.getElementById(activeCue.cueID);\n            if (htmlCaptionDiv) {\n                captionContainer.removeChild(htmlCaptionDiv);\n            }\n            renderCaption(activeCue);\n        }\n    }\n\n    function renderCaption(cue) {\n        if (captionContainer) {\n            const finalCue = document.createElement('div');\n            captionContainer.appendChild(finalCue);\n            previousISDState = renderHTML(cue.isd, finalCue, function (uri) {\n                const imsc1ImgUrnTester = /^(urn:)(mpeg:[a-z0-9][a-z0-9-]{0,31}:)(subs:)([0-9]+)$/;\n                const smpteImgUrnTester = /^#(.*)$/;\n                if (imsc1ImgUrnTester.test(uri)) {\n                    const match = imsc1ImgUrnTester.exec(uri);\n                    const imageId = parseInt(match[4], 10) - 1;\n                    const imageData = btoa(cue.images[imageId]);\n                    const dataUrl = 'data:image/png;base64,' + imageData;\n                    return dataUrl;\n                } else if (smpteImgUrnTester.test(uri)) {\n                    const match = smpteImgUrnTester.exec(uri);\n                    const imageId = match[1];\n                    const dataUrl = 'data:image/png;base64,' + cue.embeddedImages[imageId];\n                    return dataUrl;\n                } else {\n                    return null;\n                }\n            }, captionContainer.clientHeight, captionContainer.clientWidth, false/*displayForcedOnlyMode*/, function (err) {\n                logger.info('renderCaption :', err);\n                //TODO add ErrorHandler management\n            }, previousISDState, true /*enableRollUp*/);\n            finalCue.id = cue.cueID;\n            eventBus.trigger(Events.CAPTION_RENDERED, {captionDiv: finalCue, currentTrackIdx});\n        }\n    }\n\n    /*\n     * Add captions to track, store for later adding, or add captions added before\n     */\n    function addCaptions(trackIdx, timeOffset, captionData) {\n        const track = getTrackByIdx(trackIdx);\n        const self = this;\n\n        if (!track) {\n            return;\n        }\n\n        if (!captionData || captionData.length === 0) {\n            return;\n        }\n\n        for (let item = 0; item < captionData.length; item++) {\n            let cue;\n            const currentItem = captionData[item];\n\n            track.cellResolution = currentItem.cellResolution;\n            track.isFromCEA608 = currentItem.isFromCEA608;\n\n            if (currentItem.type === 'html' && captionContainer) {\n                cue = new Cue(currentItem.start - timeOffset, currentItem.end - timeOffset, '');\n                cue.cueHTMLElement = currentItem.cueHTMLElement;\n                cue.isd = currentItem.isd;\n                cue.images = currentItem.images;\n                cue.embeddedImages = currentItem.embeddedImages;\n                cue.cueID = currentItem.cueID;\n                cue.scaleCue = scaleCue.bind(self);\n                //useful parameters for cea608 subtitles, not for TTML one.\n                cue.cellResolution = currentItem.cellResolution;\n                cue.lineHeight = currentItem.lineHeight;\n                cue.linePadding = currentItem.linePadding;\n                cue.fontSize = currentItem.fontSize;\n\n                captionContainer.style.left = actualVideoLeft + 'px';\n                captionContainer.style.top = actualVideoTop + 'px';\n                captionContainer.style.width = actualVideoWidth + 'px';\n                captionContainer.style.height = actualVideoHeight + 'px';\n\n                cue.onenter = function () {\n                    if (track.mode === Constants.TEXT_SHOWING) {\n                        if (this.isd) {\n                            renderCaption(this);\n                            logger.debug('Cue enter id:' + this.cueID);\n                        } else {\n                            captionContainer.appendChild(this.cueHTMLElement);\n                            scaleCue.call(self, this);\n                            eventBus.trigger(Events.CAPTION_RENDERED, {captionDiv: this.cueHTMLElement, currentTrackIdx});\n                        }\n                    }\n                };\n\n                cue.onexit = function () {\n                    if (captionContainer) {\n                        const divs = captionContainer.childNodes;\n                        for (let i = 0; i < divs.length; ++i) {\n                            if (divs[i].id === this.cueID) {\n                                logger.debug('Cue exit id:' + divs[i].id);\n                                captionContainer.removeChild(divs[i]);\n                            }\n                        }\n                    }\n                };\n            } else {\n                if (currentItem.data) {\n                    cue = new Cue(currentItem.start - timeOffset, currentItem.end - timeOffset, currentItem.data);\n                    if (currentItem.styles) {\n                        if (currentItem.styles.align !== undefined && 'align' in cue) {\n                            cue.align = currentItem.styles.align;\n                        }\n                        if (currentItem.styles.line !== undefined && 'line' in cue) {\n                            cue.line = currentItem.styles.line;\n                        }\n                        if (currentItem.styles.position !== undefined && 'position' in cue) {\n                            cue.position = currentItem.styles.position;\n                        }\n                        if (currentItem.styles.size !== undefined && 'size' in cue) {\n                            cue.size = currentItem.styles.size;\n                        }\n                    }\n                    cue.onenter = function () {\n                        if (track.mode === Constants.TEXT_SHOWING) {\n                            eventBus.trigger(Events.CAPTION_RENDERED, {currentTrackIdx});\n                        }\n                    };\n                }\n            }\n            try {\n                if (cue) {\n                    track.addCue(cue);\n                } else {\n                    logger.error('impossible to display subtitles.');\n                }\n            } catch (e) {\n                // Edge crash, delete everything and start adding again\n                // @see https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11979877/\n                deleteTrackCues(track);\n                track.addCue(cue);\n                throw e;\n            }\n        }\n    }\n\n    function getTrackByIdx(idx) {\n        return idx >= 0 && textTrackQueue[idx] ?\n            videoModel.getTextTrack(textTrackQueue[idx].kind, textTrackQueue[idx].label, textTrackQueue[idx].lang, textTrackQueue[idx].isTTML, textTrackQueue[idx].isEmbedded) : null;\n    }\n\n    function getCurrentTrackIdx() {\n        return currentTrackIdx;\n    }\n\n    function getTrackIdxForId(trackId) {\n        let idx = -1;\n        for (let i = 0; i < textTrackQueue.length; i++) {\n            if (textTrackQueue[i].label === trackId) {\n                idx = i;\n                break;\n            }\n        }\n\n        return idx;\n    }\n\n    function setCurrentTrackIdx(idx) {\n        if (idx === currentTrackIdx) {\n            return;\n        }\n        currentTrackIdx = idx;\n        const track = getTrackByIdx(currentTrackIdx);\n        setCueStyleOnTrack.call(this, track);\n\n        if (videoSizeCheckInterval) {\n            clearInterval(videoSizeCheckInterval);\n            videoSizeCheckInterval = null;\n        }\n\n        if (track && track.renderingType === 'html') {\n            checkVideoSize.call(this, track, true);\n            videoSizeCheckInterval = setInterval(checkVideoSize.bind(this, track), 500);\n        }\n    }\n\n    function setCueStyleOnTrack(track) {\n        clearCaptionContainer.call(this);\n        if (track) {\n            if (track.renderingType === 'html') {\n                setNativeCueStyle.call(this);\n            } else {\n                removeNativeCueStyle.call(this);\n            }\n        } else {\n            removeNativeCueStyle.call(this);\n        }\n    }\n\n    function deleteTrackCues(track) {\n        if (track.cues) {\n            const cues = track.cues;\n            const lastIdx = cues.length - 1;\n\n            for (let r = lastIdx; r >= 0 ; r--) {\n                track.removeCue(cues[r]);\n            }\n        }\n    }\n\n    function deleteCuesFromTrackIdx(trackIdx) {\n        const track = getTrackByIdx(trackIdx);\n        if (track) {\n            deleteTrackCues(track);\n        }\n    }\n\n    function deleteAllTextTracks() {\n        const ln = trackElementArr ? trackElementArr.length : 0;\n        for (let i = 0; i < ln; i++) {\n            const track = getTrackByIdx(i);\n            if (track) {\n                deleteTrackCues.call(this, track);\n                track.mode = 'disabled';\n            }\n        }\n        trackElementArr = [];\n        textTrackQueue = [];\n        if (videoSizeCheckInterval) {\n            clearInterval(videoSizeCheckInterval);\n            videoSizeCheckInterval = null;\n        }\n        currentTrackIdx = -1;\n        clearCaptionContainer.call(this);\n    }\n\n    function deleteTextTrack(idx) {\n        videoModel.removeChild(trackElementArr[idx]);\n        trackElementArr.splice(idx, 1);\n    }\n\n    /* Set native cue style to transparent background to avoid it being displayed. */\n    function setNativeCueStyle() {\n        let styleElement = document.getElementById('native-cue-style');\n        if (styleElement) {\n            return; //Already set\n        }\n\n        styleElement = document.createElement('style');\n        styleElement.id = 'native-cue-style';\n        document.head.appendChild(styleElement);\n        const stylesheet = styleElement.sheet;\n        const video = videoModel.getElement();\n        try {\n            if (video) {\n                if (video.id) {\n                    stylesheet.insertRule('#' + video.id + '::cue {background: transparent}', 0);\n                } else if (video.classList.length !== 0) {\n                    stylesheet.insertRule('.' + video.className + '::cue {background: transparent}', 0);\n                } else {\n                    stylesheet.insertRule('video::cue {background: transparent}', 0);\n                }\n            }\n        } catch (e) {\n            logger.info('' + e.message);\n        }\n    }\n\n    /* Remove the extra cue style with transparent background for native cues. */\n    function removeNativeCueStyle() {\n        const styleElement = document.getElementById('native-cue-style');\n        if (styleElement) {\n            document.head.removeChild(styleElement);\n        }\n    }\n\n    function clearCaptionContainer() {\n        if (captionContainer) {\n            while (captionContainer.firstChild) {\n                captionContainer.removeChild(captionContainer.firstChild);\n            }\n        }\n    }\n\n    function setConfig(config) {\n        if (!config) {\n            return;\n        }\n        if (config.videoModel) {\n            videoModel = config.videoModel;\n        }\n    }\n\n    function setModeForTrackIdx(idx, mode) {\n        const track = getTrackByIdx(idx);\n        if (track && track.mode !== mode) {\n            track.mode = mode;\n        }\n    }\n\n    function getCurrentTrackInfo() {\n        return textTrackQueue[currentTrackIdx];\n    }\n\n    instance = {\n        initialize: initialize,\n        displayCConTop: displayCConTop,\n        addTextTrack: addTextTrack,\n        addCaptions: addCaptions,\n        getCurrentTrackIdx: getCurrentTrackIdx,\n        setCurrentTrackIdx: setCurrentTrackIdx,\n        getTrackIdxForId: getTrackIdxForId,\n        getCurrentTrackInfo: getCurrentTrackInfo,\n        setModeForTrackIdx: setModeForTrackIdx,\n        deleteCuesFromTrackIdx: deleteCuesFromTrackIdx,\n        deleteAllTextTracks: deleteAllTextTracks,\n        deleteTextTrack: deleteTextTrack,\n        setConfig: setConfig\n    };\n\n    setup();\n\n    return instance;\n}\n\nTextTracks.__dashjs_factory_name = 'TextTracks';\nexport default FactoryMaker.getSingletonFactory(TextTracks);\n"]}
>>>>>>> 5997235fa5610c22b4ba0d81e0fb862f10dfa8b3
